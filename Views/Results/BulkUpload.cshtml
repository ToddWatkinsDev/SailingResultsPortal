@model SailingResultsPortal.Models.Event

@{
    ViewData["Title"] = "Bulk Upload Results";
    string eventId = ViewData["EventId"] as string ?? Model?.Id ?? "";
    string raceId = ViewData["RaceId"] as string ?? "";
    var selectedRace = ViewData["SelectedRace"] as SailingResultsPortal.Models.Race;
    int processedCount = ViewData["ProcessedCount"] as int? ?? 0;
    var errors = ViewData["Errors"] as List<string> ?? new List<string>();
    bool isRaceSpecific = !string.IsNullOrEmpty(raceId);
}

<h1 class="text-2xl font-bold mb-4">
    @if (isRaceSpecific)
    {
        @:Bulk Upload Results for @selectedRace?.Name
    }
    else
    {
        @:Bulk Upload Results for @Model?.Name
    }
</h1>

@if (isRaceSpecific)
{
    <p class="text-gray-600 mb-4">Uploading results for: <strong>@selectedRace?.Name</strong> (@selectedRace?.HandicapSystem)</p>
}

@if (processedCount > 0)
{
    <div class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
        <strong>Success!</strong> @processedCount results were successfully processed and added.
    </div>
}

@if (errors.Any())
{
    <div class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <strong>Errors encountered:</strong>
        <ul class="mt-2 list-disc list-inside">
            @foreach (var error in errors)
            {
                <li>@error</li>
            }
        </ul>
    </div>
}

<div class="mb-4">
    <a href="/Results/DownloadTemplate?eventId=@eventId@if (isRaceSpecific) { <text>&raceId=@raceId</text> }" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
        üì• Download JSON Template
    </a>
    <p class="text-sm text-gray-600 mt-1">Download a sample JSON file with the correct format for bulk upload</p>
</div>

<form method="post" asp-action="BulkUpload" class="space-y-4">
    <input type="hidden" name="eventId" value="@eventId" />
    @if (isRaceSpecific)
    {
        <input type="hidden" name="raceId" value="@raceId" />
    }

    <div>
        <label for="jsonData" class="block text-sm font-medium text-gray-700 mb-2">
            JSON Data
        </label>
        <textarea id="jsonData" name="jsonData" rows="20"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
                  placeholder='[
  {
    "ClassId": "Laser",
    "SailorName": "John Doe 123",
    "SailNumber": "ABC123",
    "FinishTime": "00:45:30",
    "Status": null,
    "HandicapNumber": 1100
  }
]' required></textarea>

        <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
            <p class="text-sm text-blue-800">
                <strong>üìã Required fields:</strong>
                @if (isRaceSpecific)
                {
                    <text>SailorName, SailNumber</text>
                }
                else
                {
                    <text>RaceId, SailorName, SailNumber</text>
                }
                <br>
                <strong>‚è±Ô∏è FinishTime:</strong> Use "hh:mm:ss" format (e.g., "00:45:30")<br>
                <strong>üèÅ Status:</strong> null (finished), "DNS", "DNC", "DNF", or "RET"<br>
                <strong>‚öñÔ∏è HandicapNumber:</strong> Required for Open handicap races (e.g., Portsmouth number)<br>
                <strong>üë§ SailorName:</strong> Can include letters, numbers, spaces, hyphens, apostrophes, and periods
            </p>
        </div>
        <p class="text-sm text-gray-600 mt-2">
            Paste your JSON data here. For Open handicap races, include the HandicapNumber field with the boat's handicap rating.
        </p>
    </div>

    <div class="flex gap-4">
        <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            üì§ Upload Results
        </button>
        <a href="/Results?eventId=@eventId" class="px-6 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
            Cancel
        </a>
    </div>
</form>

<div class="mt-8 p-4 bg-gray-50 rounded-lg">
    <h3 class="text-lg font-semibold mb-2">JSON Format Guide</h3>
    <p class="text-sm text-gray-600 mb-2">Your JSON should be an array of result objects with the following structure:</p>
    <pre class="bg-white p-3 rounded border text-xs overflow-x-auto"><code>[
  {
    "ClassId": "Laser",
    "SailorName": "John Doe 123",
    "SailNumber": "ABC123",
    "FinishTime": "00:45:30",
    "Status": null,
    "HandicapNumber": 1100
  }
]</code></pre>
</div>